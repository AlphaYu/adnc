## å‰è¨€

å½“å‰æ˜¯å®¹å™¨åŒ–éƒ¨ç½²çš„æ—¶ä»£ï¼Œæ— è®ºæ˜¯å¦é‡‡ç”¨åˆ†å¸ƒå¼/å¾®æœåŠ¡æ¶æ„ï¼Œæ¨èä½¿ç”¨ `Docker` è¿›è¡Œéƒ¨ç½²ã€‚`Linux` + `Docker` æ˜¯æœ€ä½³ç»„åˆï¼Œå¦‚æœæ‚¨ä½¿ç”¨ `Windows`ï¼Œå¯ä»¥è€ƒè™‘å®‰è£… `Linux` è™šæ‹Ÿæœºä»¥æé«˜å…¼å®¹æ€§å’Œéƒ¨ç½²æ•ˆç‡ã€‚`ADNC` åœ¨æœåŠ¡å™¨ä¸Šçš„éƒ¨ç½²éœ€è¦å…ˆå®‰è£… `MySQL`ã€`Redis`ã€`RabbitMQ`ã€`Loki`ã€`Consul` å’Œ `Nginx`ã€‚

- æ–‡æ¡£ä¸­ `10.2.8.5` ä¸ºä½œè€…æœåŠ¡å™¨çš„å†…ç½‘ IPï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µæ›´æ¢ã€‚
- æœåŠ¡å™¨æ“ä½œç³»ç»Ÿï¼š`Ubuntu 22.04`
- æœåŠ¡å™¨éœ€é¢„å…ˆå®‰è£… `Docker` å’Œ `Docker Compose`

## 1. è·å–ç¯å¢ƒå®‰è£…è„šæœ¬

```bash
# åœ¨æœ¬åœ° `adnc` ç›®å½•æ‰§è¡Œ
git submodule init
# æ‹‰å–æ‰€æœ‰å­æ¨¡å—
git submodule update --recursive  
# æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
git submodule foreach --recursive git pull origin main
```

## 2. ç¯å¢ƒå®‰è£…

### 2.1 ç™»å½•æœåŠ¡å™¨å¹¶åˆ›å»ºç›®å½•

```bash
sudo mkdir -p /adnc
cd /adnc
```

### 2.2 ä¸Šä¼ ç¯å¢ƒéƒ¨ç½²è„šæœ¬

- åœ¨æœ¬åœ° `adnc` ç›®å½•ä¸‹è¿›å…¥ `doc` æ–‡ä»¶å¤¹ï¼Œå°† `adnc/doc/devops` ç›®å½•ä¸Šä¼ è‡³æœåŠ¡å™¨ `/adnc` ç›®å½•ã€‚

**ä¸Šä¼ åæœåŠ¡å™¨ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š**

```bash
adnc
â””â”€â”€ devops
    â””â”€â”€ docker-compose
```

### 2.3 æ‰§è¡Œç¯å¢ƒéƒ¨ç½²è„šæœ¬

```bash
cd /adnc/devops/docker-compose
sudo docker-compose up -d
```

**`docker-compose.yml` æ–‡ä»¶å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š**

- éƒ¨ç½² `Consul` é›†ç¾¤å¹¶åˆå§‹åŒ–é…ç½®ä¿¡æ¯
- éƒ¨ç½² `MariaDB` å¹¶åˆå§‹åŒ–æ•°æ®åº“
- éƒ¨ç½² `Redis`
- éƒ¨ç½² `RabbitMQ`
- éƒ¨ç½² `Loki`
- éƒ¨ç½² `Grafana`

## 3. ä¿®æ”¹ Consul é…ç½®ä¿¡æ¯

3.1  è®¿é—® Consul UIï¼š`http://æœåŠ¡å™¨IP:8590`
3.2 å°† `10.2.8.5` æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨ IP

| æœåŠ¡å                | æè¿°         | é…ç½®è·¯å¾„                              |
| --------------------- | ------------ | ------------------------------------- |
| `Adnc.Gateway.Ocelot` | Ocelot ç½‘å…³  | `/adnc/staging/gateway/appsettings`   |
| `Adnc.Demo.Admin.Api` | ç³»ç»Ÿç®¡ç†æœåŠ¡ | `/adnc/staging/admin-api/appsettings` |
| `Adnc.Demo.Maint.Api` | è¿ç»´ç®¡ç†æœåŠ¡ | `/adnc/staging/maint-api/appsettings` |
| `Adnc.Demo.Cust.Api`  | å®¢æˆ·ç®¡ç†æœåŠ¡ | `/adnc/staging/cust-api/appsettings`  |
| -                     | å…¬å…±é…ç½®     | `/adnc/staging/shared/appsettings`    |

> `ADNC` å°†ä» `Consul` è¯»å– `appsettings` é…ç½®å¹¶å¡«å…… `Configuration` å¯¹è±¡ã€‚ `Consul` ä»»æ„èŠ‚ç‚¹çš„ `Key/Value` é…ç½®éƒ½ä¼šè‡ªåŠ¨åŒæ­¥è‡³å…¶ä»–èŠ‚ç‚¹ã€‚ é…ç½®ç¤ºä¾‹å‚è€ƒæœ¬åœ° `adnc/doc/consul/demo` ç›®å½•ä¸­çš„ `JSON` æ–‡ä»¶ã€‚

## 4. éƒ¨ç½²åç«¯

### 4.1 å®‰è£… .NET 8 SDK

```bash
sudo apt-get update && \
sudo apt-get install -y dotnet-sdk-8.0
```

### 4.2 åˆ›å»º `adnc` ç›®å½•å¹¶è®¾ç½®æƒé™

```bash
sudo mkdir -p /adnc/nginx/{conf.d,html,logs,ssl}
sudo mkdir -p /adnc/src
sudo chmod -R 777 /adnc
```

### 4.3 ä¸Šä¼ åç«¯ä»£ç 

> ä¸Šä¼ å‰å…ˆæ‰§è¡Œ `Delete-BIN-OBJ-Folders.bat`ï¼Œè¯¥æ–‡ä»¶ä¼šæ¸…ç† `bin` å’Œ `obj` ç›®å½•ã€‚

**éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼š**

- `Demo` ç›®å½•
- `Gateways` ç›®å½•
- `Directory.Build.props`
- `deploy_demo.sh`
- `deploy_ocelot.sh`

**ä¸Šä¼ åæœåŠ¡å™¨ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š**

```bash
adnc
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ Demo
â”‚   â”œâ”€â”€ Gateways
â”‚   â”œâ”€â”€ deploy_demo.sh
â”‚   â”œâ”€â”€ deploy_ocelot.sh
â”‚   â””â”€â”€ Directory.Build.props
â””â”€â”€ nginx
```

### 4.4 æ‰§è¡Œéƒ¨ç½²è„šæœ¬

```bash
cd /adnc/src
# èµ‹äºˆæ‰§è¡Œæƒé™
sudo chmod +x deploy_demo.sh deploy_ocelot.sh
# æ‰§è¡Œéƒ¨ç½²
sudo bash deploy_demo.sh
sudo bash deploy_ocelot.sh
```

### 4.5 éªŒè¯åç«¯æœåŠ¡

- è®¿é—® Consul UI æŸ¥çœ‹ `Demo` æœåŠ¡æ˜¯å¦æˆåŠŸæ³¨å†Œã€‚
- è®¿é—® `http://æœåŠ¡å™¨IP:5000` æ£€æŸ¥ç½‘å…³æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

## 5. éƒ¨ç½²å‰ç«¯

### 5.1 åˆ›å»º `nginx.conf` æ–‡ä»¶

```bash
sudo touch /adnc/nginx/nginx.conf
sudo chmod 777 /adnc/nginx/nginx.conf
```

### 5.2 é…ç½® `nginx.conf`

```bash
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    gzip on;
    gzip_types text/plain application/javascript text/css;

    server {
        listen 80;
        server_name localhost;
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
        location /api/ {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://10.2.8.5:5000/api/;
        }
    }
}
```

### 5.3 å¯åŠ¨ Nginx

```bash
sudo docker run -it -d --restart always --network host \
  --name adnc-nginx \
  -v /adnc/nginx/nginx.conf:/etc/nginx/nginx.conf \
  -v /adnc/nginx/html:/usr/share/nginx/html \
  -v /adnc/nginx/logs:/var/log/nginx/ \
  -v /adnc/nginx/ssl:/etc/nginx/ssl \
  -e TZ=Asia/Shanghai \
  nginx
```

### 5.4 æ‰“åŒ…å¹¶éƒ¨ç½²å‰ç«¯

```bash
pnpm run build
```

- `build` æˆåŠŸåï¼Œå°† `dist` ç›®å½•å†…çš„æ–‡ä»¶ä¸Šä¼ è‡³ `/adnc/nginx/html`ã€‚
- è®¿é—® `http://æœåŠ¡å™¨IP`ï¼Œå¦‚æˆåŠŸæ˜¾ç¤ºç™»å½•é¡µé¢ï¼Œåˆ™ `ADNC` éƒ¨ç½²æˆåŠŸã€‚

------

## 6. ç»“è¯­

ğŸ‰ æ­å–œæ‚¨ï¼Œ`ADNC` æ¡†æ¶å·²æˆåŠŸéƒ¨ç½²ï¼

å¦‚æœæœ¬é¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ `Star` & `Fork` æ”¯æŒï¼

[ADNC](https://aspdotnetcore.net/) â€”â€” ä¸€ä¸ªå¯è½åœ°çš„ .NET å¾®æœåŠ¡/åˆ†å¸ƒå¼å¼€å‘æ¡†æ¶ã€‚